# Bot è¢«@æ—¶AIå›å¤æŠ€æœ¯æ–¹æ¡ˆ

**å½“å‰å®ç°è¯´æ˜**ï¼šrunner å·²é‡‡ç”¨ **SyncAIHandler**ï¼ˆé“¾å†…åŒæ­¥æ‰§è¡Œ AIï¼Œè¿”å› `Reply` ä¾› MemoryMiddleware åœ¨ `after()` ä¸­å­˜è®°å¿†ï¼‰ã€‚åŸæœ‰çš„ **AIQueryHandler**ï¼ˆå¼‚æ­¥é€šé“ + ç‹¬ç«‹ä»»åŠ¡ï¼‰å·²ç§»é™¤ã€‚ä¸‹æ–‡ä¸­æ¶‰åŠ AIQueryHandler / é€šé“ / start_ai_handler çš„æè¿°ä¸ºå†å²æ–¹æ¡ˆï¼Œå®é™…ä»£ç ä»¥ `ai-handlers/src/sync_ai_handler.rs` ä¸ `telegram-bot/src/runner.rs` ä¸ºå‡†ã€‚

## ğŸ“‹ å¼€å‘å®æ–½æ¸…å•

---

### é˜¶æ®µä¸€ï¼šå‡†å¤‡å·¥ä½œ

#### 1.1 é…ç½®ç¯å¢ƒå˜é‡

åˆ›å»ºæˆ–æ›´æ–° `.env` æ–‡ä»¶ï¼š

```env
# å¿…éœ€é…ç½®
BOT_TOKEN=your_bot_token                    # Telegram Bot Token
OPENAI_API_KEY=your_openai_api_key          # OpenAI API Key

# å¯é€‰é…ç½®ï¼ˆæœ‰é»˜è®¤å€¼ï¼‰
OPENAI_BASE_URL=https://api.openai.com/v1    # OpenAI API åœ°å€
DATABASE_URL=file:./telegram_bot.db         # æ•°æ®åº“è·¯å¾„
RATE_LIMIT_MAX_REQUESTS=10                  # é€Ÿç‡é™åˆ¶è¯·æ±‚æ•°
RATE_LIMIT_WINDOW_SECS=60                   # é€Ÿç‡é™åˆ¶çª—å£ï¼ˆç§’ï¼‰
RUST_LOG=info                               # æ—¥å¿—çº§åˆ«
```

- [ ] åˆ›å»º/æ›´æ–° `.env` æ–‡ä»¶
- [ ] é…ç½® BOT_TOKENï¼ˆä» @BotFather è·å–ï¼‰
- [ ] é…ç½® OPENAI_API_KEYï¼ˆä» OpenAI è·å–ï¼‰
- [ ] æ ¹æ®éœ€è¦è°ƒæ•´å…¶ä»–é…ç½®

#### 1.2 æ›´æ–°ä¾èµ–

ç¼–è¾‘ `dbot-cli/Cargo.toml`ï¼š

```toml
[dependencies]
telegram-bot-ai = { path = "../telegram-bot-ai" }
openai-client = { path = "../openai-client" }
```

- [ ] ä¿®æ”¹ `dbot-cli/Cargo.toml`
- [ ] æ·»åŠ  telegram-bot-ai ä¾èµ–
- [ ] æ·»åŠ  openai-client ä¾èµ–

---

### é˜¶æ®µäºŒï¼šHandlerChain æœºåˆ¶

#### 2.1 åˆ›å»º HandlerChain

æ–°å»º `bot-runtime/src/handler_chain.rs`

- [ ] åˆ›å»ºæ–‡ä»¶ `bot-runtime/src/handler_chain.rs`
- [ ] å®ç° `HandlerChain` ç»“æ„ä½“
- [ ] å®ç° `add_handler()` æ–¹æ³•
- [ ] å®ç° `handle()` æ–¹æ³•ï¼ˆé“¾å¼å¤„ç†é€»è¾‘ï¼‰

#### 2.2 å¯¼å‡º HandlerChain

ç¼–è¾‘ `bot-runtime/src/lib.rs`ï¼š

```rust
pub mod handler_chain;
pub use handler_chain::HandlerChain;
```

- [ ] ä¿®æ”¹ `bot-runtime/src/lib.rs`
- [ ] æ·»åŠ  handler_chain æ¨¡å—
- [ ] å¯¼å‡º HandlerChain

#### 2.3 éªŒè¯ HandlerChain

- [ ] è¿è¡Œ `cargo check` ç¡®ä¿ç¼–è¯‘é€šè¿‡
- [ ] è¿è¡Œ `cargo run` éªŒè¯ bot æ­£å¸¸å¯åŠ¨

**é˜¶æ®µäºŒå®Œæˆå**ï¼š
- âœ… å¯ä»¥ç¼–è¯‘è¿è¡Œ
- âœ… bot æ­£å¸¸å¯åŠ¨
- âŒ HandlerChain æœªå®é™…ä½¿ç”¨ï¼ŒåŠŸèƒ½æ— å˜åŒ–

---

### é˜¶æ®µä¸‰ï¼šAIæ£€æµ‹å’Œå¤„ç†

#### 3.1 åˆ›å»º AIDetectionHandler

æ–°å»º `bot-runtime/src/ai_detection_handler.rs`

- [ ] åˆ›å»ºæ–‡ä»¶ `bot-runtime/src/ai_detection_handler.rs`
- [ ] å®šä¹‰ `AIQuery` ç»“æ„ä½“
- [ ] å®ç° `AIDetectionHandler` ç»“æ„ä½“
- [ ] å®ç° `is_bot_mentioned()` æ–¹æ³•
- [ ] å®ç° `extract_question()` æ–¹æ³•
- [ ] å®ç° `Handler` trait çš„ `handle()` æ–¹æ³•
- [ ] æ£€æµ‹åˆ°@æåŠæ—¶å‘é€åˆ°æŸ¥è¯¢é˜Ÿåˆ—

#### 3.2 åˆ›å»º AIQueryHandler

æ–°å»º `bot-runtime/src/ai_query_handler.rs`

- [ ] åˆ›å»ºæ–‡ä»¶ `bot-runtime/src/ai_query_handler.rs`
- [ ] å®ç° `AIQueryHandler` ç»“æ„ä½“
- [ ] å®ç° `run()` æ–¹æ³•ï¼ˆå¼‚æ­¥ä»»åŠ¡ä¸»å¾ªç¯ï¼‰
- [ ] å®ç° `handle_query()` æ–¹æ³•ï¼ˆå¤„ç†å•ä¸ªæŸ¥è¯¢ï¼‰
- [ ] å®ç° `send_response()` æ–¹æ³•ï¼ˆå‘é€å›å¤ï¼‰
- [ ] å®ç° `log_ai_response()` æ–¹æ³•ï¼ˆè®°å½•AIå›å¤ï¼‰

#### 3.3 å¯¼å‡º AI æ¨¡å—

ç¼–è¾‘ `bot-runtime/src/lib.rs`ï¼š

```rust
pub mod ai_detection_handler;
pub mod ai_query_handler;

pub use ai_detection_handler::{AIDetectionHandler, AIQuery};
```

- [ ] ä¿®æ”¹ `bot-runtime/src/lib.rs`
- [ ] æ·»åŠ  ai_detection_handler æ¨¡å—
- [ ] æ·»åŠ  ai_query_handler æ¨¡å—
- [ ] å¯¼å‡º AIDetectionHandler å’Œ AIQuery

#### 3.4 é›†æˆ AI åŠŸèƒ½

ç¼–è¾‘ `dbot-cli/src/main.rs`ï¼š

- [ ] åˆ›å»º AI æŸ¥è¯¢é€šé“ï¼ˆmpsc::unbounded_channelï¼‰
- [ ] åˆå§‹åŒ– `TelegramBotAI`ï¼ˆOpenAIå®¢æˆ·ç«¯ï¼‰
- [ ] åˆå§‹åŒ– `AIDetectionHandler`ï¼ˆæ£€æµ‹å±‚ï¼‰
- [ ] åˆå§‹åŒ– `AIQueryHandler`ï¼ˆå¤„ç†å±‚ï¼‰
- [ ] åˆ›å»º `HandlerChain` å¹¶æ·»åŠ  handler
- [ ] åœ¨ `teloxide::repl` ä¸­ä½¿ç”¨ HandlerChain å¤„ç†æ¶ˆæ¯
- [ ] åœ¨ tokio::spawn ä¸­å¯åŠ¨ `AIQueryHandler::run()`
- [ ] åœ¨ tokio::spawn ä¸­å¯åŠ¨ `get_me()` è·å– bot username

#### 3.5 éªŒè¯ AI åŠŸèƒ½

- [ ] è¿è¡Œ `cargo check` ç¡®ä¿ç¼–è¯‘é€šè¿‡
- [ ] è¿è¡Œ `cargo run` å¯åŠ¨ bot
- [ ] åœ¨ Telegram ä¸­ @æåŠ bot æµ‹è¯• AI å›å¤
- [ ] éªŒè¯æ•°æ®åº“ä¸­è®°å½•äº†ç”¨æˆ·æ¶ˆæ¯å’Œ AI å›å¤

**é˜¶æ®µä¸‰å®Œæˆå**ï¼š
- âœ… å¯ä»¥ç¼–è¯‘è¿è¡Œ
- âœ… bot æ­£å¸¸å¯åŠ¨
- âœ… @æåŠæ£€æµ‹å’Œ AI å›å¤åŠŸèƒ½å®Œæ•´

---

### é˜¶æ®µå››ï¼šæµå¼å“åº”ï¼ˆå¯é€‰ï¼‰

> âš ï¸ **æœ¬é˜¶æ®µä¸ºå¯é€‰åŠŸèƒ½**ï¼Œç”¨äºæå‡ç”¨æˆ·ä½“éªŒï¼Œå®ç° AI å›å¤çš„æµå¼è¾“å‡ºã€‚

#### 4.1 æ›´æ–° AIQueryHandler æ”¯æŒæµå¼å“åº”

ç¼–è¾‘ `bot-runtime/src/ai_query_handler.rs`ï¼š

- [ ] æ·»åŠ  `use_streaming` é…ç½®é€‰é¡¹ï¼ˆä»ç¯å¢ƒå˜é‡è¯»å–ï¼‰
- [ ] å®ç°æµå¼å“åº”å¤„ç†æ–¹æ³• `handle_query_stream()`
- [ ] æ·»åŠ æ¶ˆæ¯ ID è¿½è¸ªï¼ˆç”¨äºç¼–è¾‘æ¶ˆæ¯ï¼‰

#### 4.2 å®ç°æµå¼å“åº”é€»è¾‘

- [ ] è°ƒç”¨ `TelegramBotAI::get_ai_response_stream()` æ–¹æ³•
- [ ] é¦–æ¬¡æ”¶åˆ° chunk æ—¶ï¼Œå‘é€åˆå§‹æ¶ˆæ¯ "æ­£åœ¨æ€è€ƒ..."
- [ ] æ”¶åˆ°åç»­ chunk æ—¶ï¼Œä½¿ç”¨ `bot.edit_message_text()` æ›´æ–°å†…å®¹
- [ ] å¤„ç†å®Œæˆåï¼Œä¿å­˜å®Œæ•´å›å¤åˆ°æ•°æ®åº“

#### 4.3 æµå¼å“åº”ä»£ç ç¤ºä¾‹

```rust
async fn handle_query_stream(&self, query: AIQuery) -> Result<()> {
    // 1. å‘é€åˆå§‹æ¶ˆæ¯
    let message = self.bot
        .send_message(query.chat_id, "æ­£åœ¨æ€è€ƒ...")
        .await?;

    // 2. è°ƒç”¨æµå¼ AI API
    let mut full_response = String::new();
    self.ai_bot.get_ai_response_stream(&query.question, |chunk| async {
        full_response += &chunk.content;

        // 3. ç¼–è¾‘æ¶ˆæ¯å†…å®¹
        self.bot
            .edit_message_text(query.chat_id, message.id, &full_response)
            .await?;

        Ok(())
    }).await?;

    // 4. è®°å½•å®Œæ•´å›å¤
    self.log_ai_response(&query, &full_response).await?;
    Ok(())
}
```

- [ ] å°†ä¸Šè¿°ä»£ç é€»è¾‘é›†æˆåˆ° `handle_query()` æ–¹æ³•
- [ ] æ ¹æ® `use_streaming` é…ç½®é€‰æ‹©å¤„ç†æ–¹å¼

#### 4.4 æ›´æ–°é…ç½®

ç¼–è¾‘ `.env` æ–‡ä»¶ï¼š

```env
# æµå¼å“åº”é…ç½®
AI_USE_STREAMING=true                       # æ˜¯å¦å¯ç”¨æµå¼å“åº”
AI_THINKING_MESSAGE=æ­£åœ¨æ€è€ƒ...             # åˆå§‹æç¤ºæ–‡æœ¬
```

- [ ] æ·»åŠ  `AI_USE_STREAMING` ç¯å¢ƒå˜é‡
- [ ] æ·»åŠ  `AI_THINKING_MESSAGE` ç¯å¢ƒå˜é‡

#### 4.5 éªŒè¯æµå¼å“åº”

- [ ] è¿è¡Œ `cargo check` ç¡®ä¿ç¼–è¯‘é€šè¿‡
- [ ] è¿è¡Œ `cargo run` å¯åŠ¨ bot
- [ ] åœ¨ Telegram ä¸­ @æåŠ bot
- [ ] è§‚å¯Ÿæ¶ˆæ¯æ˜¯å¦å®æ—¶æ›´æ–°ï¼ˆæµå¼è¾“å‡ºï¼‰
- [ ] åˆ‡æ¢ `AI_USE_STREAMING=false` éªŒè¯éæµå¼æ¨¡å¼

**é˜¶æ®µå››å®Œæˆå**ï¼š
- âœ… AI å›å¤æ”¯æŒæµå¼è¾“å‡º
- âœ… ç”¨æˆ·ä½“éªŒå¾—åˆ°æå‡
- âœ… å¯é€šè¿‡é…ç½®åˆ‡æ¢æµå¼/éæµå¼æ¨¡å¼

---

### é˜¶æ®µäº”ï¼šæµ‹è¯•å’Œä¼˜åŒ–

#### 4.1 ä»£ç è´¨é‡æ£€æŸ¥

- [ ] è¿è¡Œ `cargo clippy` æ£€æŸ¥ä»£ç è´¨é‡
- [ ] è¿è¡Œ `cargo fmt` æ ¼å¼åŒ–ä»£ç 

#### 4.2 åŠŸèƒ½æµ‹è¯•

- [ ] åœ¨ Telegram ä¸­ @æåŠ bot æµ‹è¯•æ­£å¸¸å›å¤
- [ ] æµ‹è¯• @æåŠä½†é—®é¢˜ä¸ºç©ºçš„æƒ…å†µ
- [ ] æµ‹è¯•é@æåŠçš„æ™®é€šæ¶ˆæ¯ï¼ˆåº”æ­£å¸¸è®°å½•ï¼‰
- [ ] æµ‹è¯•é€Ÿç‡é™åˆ¶ï¼ˆå¿«é€Ÿå‘é€ 11 æ¡æ¶ˆæ¯ï¼‰
- [ ] æ£€æŸ¥æ•°æ®åº“ä¸­æ­£ç¡®è®°å½•ç”¨æˆ·æ¶ˆæ¯
- [ ] æ£€æŸ¥æ•°æ®åº“ä¸­æ­£ç¡®è®°å½• AI å›å¤

#### 4.3 é”™è¯¯å¤„ç†æµ‹è¯•

- [ ] æµ‹è¯•æ— æ•ˆçš„ OpenAI API keyï¼ˆåº”è¿”å›é”™è¯¯æç¤ºï¼‰
- [ ] æµ‹è¯•ç½‘ç»œé”™è¯¯æƒ…å†µï¼ˆåº”è¿”å›é”™è¯¯æç¤ºï¼‰
- [ ] æµ‹è¯• OpenAI API è¶…æ—¶ï¼ˆåº”è¿”å›é”™è¯¯æç¤ºï¼‰
- [ ] æµ‹è¯• bot æœªå¯åŠ¨æ—¶å‘é€æ¶ˆæ¯ï¼ˆåº”æœ‰æ—¥å¿—ï¼‰

#### 4.4 æ€§èƒ½æµ‹è¯•

- [ ] æµ‹è¯•å•ç”¨æˆ·å¿«é€Ÿå‘é€ 20 æ¡æ¶ˆæ¯
- [ ] æµ‹è¯•å¤šä¸ªç”¨æˆ·åŒæ—¶ @æåŠ bot
- [ ] è§‚å¯Ÿ AI å“åº”æ—¶é—´ï¼ˆæ­£å¸¸åº”åœ¨ 1-5s å†…ï¼‰
- [ ] æ£€æŸ¥ CPU å’Œå†…å­˜ä½¿ç”¨æƒ…å†µ

**é˜¶æ®µå››å®Œæˆå**ï¼š
- âœ… å¯ä»¥ç¼–è¯‘è¿è¡Œ
- âœ… æ‰€æœ‰åŠŸèƒ½æµ‹è¯•é€šè¿‡
- âœ… é”™è¯¯å¤„ç†éªŒè¯å®Œæ¯•
- âœ… æ€§èƒ½æŒ‡æ ‡ç¬¦åˆé¢„æœŸ

---

### é˜¶æ®µå…­ï¼šé€Ÿç‡é™åˆ¶ï¼ˆå¯é€‰ï¼‰

> âš ï¸ **æœ¬é˜¶æ®µä¸ºå¯é€‰åŠŸèƒ½**ï¼Œç”¨äºæ§åˆ¶ OpenAI API è°ƒç”¨é¢‘ç‡ï¼Œé¿å…äº§ç”Ÿè¿‡é«˜è´¹ç”¨ã€‚

#### 6.1 åˆ›å»º RateLimiter

æ–°å»º `bot-runtime/src/rate_limiter.rs`

- [ ] åˆ›å»ºæ–‡ä»¶ `bot-runtime/src/rate_limiter.rs`
- [ ] å®šä¹‰ `RateLimitConfig` ç»“æ„ä½“
- [ ] å®ç° `RateLimiter` ç»“æ„ä½“
- [ ] å®ç° `is_rate_limited()` æ–¹æ³•
- [ ] å®ç° `record_request()` æ–¹æ³•ï¼ˆè®°å½•è¯·æ±‚ï¼‰

#### 6.2 å¯¼å‡º RateLimiter

ç¼–è¾‘ `bot-runtime/src/lib.rs`ï¼š

```rust
pub mod rate_limiter;
pub use rate_limiter::{RateLimiter, RateLimitConfig};
```

- [ ] ä¿®æ”¹ `bot-runtime/src/lib.rs`
- [ ] æ·»åŠ  rate_limiter æ¨¡å—
- [ ] å¯¼å‡º RateLimiter å’Œ RateLimitConfig

#### 6.3 é›†æˆé€Ÿç‡é™åˆ¶åˆ° AIQueryHandler

ç¼–è¾‘ `bot-runtime/src/ai_query_handler.rs`ï¼š

- [ ] åœ¨ AIQueryHandler ä¸­æ·»åŠ  RateLimiter å­—æ®µ
- [ ] åœ¨ `handle_query()` å¼€å§‹æ—¶è°ƒç”¨ `is_rate_limited()`
- [ ] å¦‚æœè¶…é™ï¼Œè·³è¿‡æœ¬æ¬¡ AI è°ƒç”¨
- [ ] å¦‚æœæœªè¶…é™ï¼Œè°ƒç”¨ AI åæ‰§è¡Œ `record_request()`

#### 6.4 éªŒè¯é€Ÿç‡é™åˆ¶

- [ ] è¿è¡Œ `cargo check` ç¡®ä¿ç¼–è¯‘é€šè¿‡
- [ ] è¿è¡Œ `cargo run` å¯åŠ¨ bot
- [ ] å¿«é€Ÿ @æåŠ bot 11 æ¬¡
- [ ] éªŒè¯ç¬¬ 11 æ¬¡è¢«æ‹’ç»ï¼ˆé€Ÿç‡é™åˆ¶ç”Ÿæ•ˆï¼‰
- [ ] ç­‰å¾… 1 åˆ†é’Ÿåå†å‘é€ï¼ŒéªŒè¯æ¢å¤æ­£å¸¸

**é˜¶æ®µäº”å®Œæˆå**ï¼š
- âœ… AI è°ƒç”¨å—åˆ°é€Ÿç‡é™åˆ¶ä¿æŠ¤
- âœ… å¯æœ‰æ•ˆæ§åˆ¶ API æˆæœ¬
- âœ… é˜²æ­¢æ¶æ„ç”¨æˆ·æ»¥ç”¨

---

### ğŸ“Š è¿›åº¦è·Ÿè¸ª

| é˜¶æ®µ | ä»»åŠ¡æ•° | å®Œæˆæ•° | è¿›åº¦ | å¯è¿è¡Œ |
|------|--------|--------|------|--------|
| é˜¶æ®µä¸€ï¼šå‡†å¤‡å·¥ä½œ | 7 | 0 | 0% | âœ… |
| é˜¶æ®µäºŒï¼šHandlerChain æœºåˆ¶ | 9 | 0 | 0% | âœ… |
| é˜¶æ®µä¸‰ï¼šAIæ£€æµ‹å’Œå¤„ç† | 29 | 0 | 0% | âœ… |
| é˜¶æ®µå››ï¼šæµå¼å“åº”ï¼ˆå¯é€‰ï¼‰ | 14 | 0 | 0% | âœ… |
| é˜¶æ®µäº”ï¼šæµ‹è¯•å’Œä¼˜åŒ– | 16 | 0 | 0% | âœ… |
| é˜¶æ®µå…­ï¼šé€Ÿç‡é™åˆ¶ï¼ˆå¯é€‰ï¼‰ | 17 | 0 | 0% | âœ… |
| **æ€»è®¡** | **92** | **0** | **0%** | |

> âœ… **å‰ä¸‰ä¸ªé˜¶æ®µå®Œæˆåéƒ½å¯ä»¥ç¼–è¯‘è¿è¡Œï¼ŒåŠŸèƒ½é€æ­¥å¢å¼º**
> âš ï¸ **é˜¶æ®µå››ã€å…­ä¸ºå¯é€‰åŠŸèƒ½ï¼Œç”¨äºæå‡ä½“éªŒå’Œæ§åˆ¶æˆæœ¬**

### ğŸ¯ é˜¶æ®µåŠŸèƒ½è¯´æ˜

| é˜¶æ®µ | å®ŒæˆååŠŸèƒ½ | éªŒè¯æ–¹å¼ |
|------|-----------|---------|
| é˜¶æ®µä¸€ï¼šå‡†å¤‡å·¥ä½œ | ç¯å¢ƒé…ç½®å®Œæˆ | `cargo run` å¯åŠ¨æ­£å¸¸ |
| é˜¶æ®µäºŒï¼šHandlerChain æœºåˆ¶ | HandlerChain æ¨¡å—å¯ç”¨ | `cargo check` ç¼–è¯‘é€šè¿‡ |
| é˜¶æ®µä¸‰ï¼šAIæ£€æµ‹å’Œå¤„ç† | å®Œæ•´ AI åŠŸèƒ½å¯ç”¨ | @æåŠ bot è·å¾—æ™ºèƒ½å›å¤ |
| é˜¶æ®µå››ï¼šæµå¼å“åº”ï¼ˆå¯é€‰ï¼‰ | AI å›å¤å®æ—¶æ›´æ–° | è§‚å¯Ÿæ¶ˆæ¯é€æ­¥ç”Ÿæˆ |
| é˜¶æ®µäº”ï¼šæµ‹è¯•å’Œä¼˜åŒ– | åŠŸèƒ½æµ‹è¯•é€šè¿‡ï¼Œæ€§èƒ½è‰¯å¥½ | æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹é€šè¿‡ |
| é˜¶æ®µå…­ï¼šé€Ÿç‡é™åˆ¶ï¼ˆå¯é€‰ï¼‰ | AI è°ƒç”¨é¢‘ç‡é™åˆ¶ç”Ÿæ•ˆ | å¿«é€Ÿ @æåŠ 11 æ¬¡è¢«æ‹’ç» |

---

### ğŸ¯ æ ¸å¿ƒç›®æ ‡

åœ¨ Telegram Bot ä¸­å®ç° @æåŠè§¦å‘ AI æ™ºèƒ½å›å¤åŠŸèƒ½ï¼Œæ”¯æŒï¼š
- âœ… @æåŠæ£€æµ‹
- âœ… AI æ™ºèƒ½å›å¤
- âœ… å¼‚æ­¥é˜Ÿåˆ—å¤„ç†
- âœ… æµå¼å“åº”ï¼ˆå¯é€‰ï¼‰
- âœ… é€Ÿç‡é™åˆ¶ä¿æŠ¤
- âœ… å®Œæ•´æ¶ˆæ¯è®°å½•

### ğŸ“‚ å…³é”®æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | ç±»å‹ | é˜¶æ®µ | è¯´æ˜ |
|------|------|------|------|
| `.env` | æ–°å»º/ä¿®æ”¹ | 1,4,6 | ç¯å¢ƒå˜é‡ã€æµå¼å’Œé€Ÿç‡é™åˆ¶é…ç½® |
| `dbot-cli/Cargo.toml` | ä¿®æ”¹ | 1 | ä¾èµ–é…ç½® |
| `bot-runtime/src/handler_chain.rs` | æ–°å»º | 2 | Handleré“¾æœºåˆ¶ |
| `bot-runtime/src/ai_detection_handler.rs` | æ–°å»º | 3 | AIæ£€æµ‹å±‚ |
| `bot-runtime/src/ai_query_handler.rs` | æ–°å»º | 3,4 | AIå¤„ç†å±‚ï¼ˆæ”¯æŒæµå¼ï¼‰ |
| `bot-runtime/src/rate_limiter.rs` | æ–°å»º | 6 | AIè°ƒç”¨é€Ÿç‡é™åˆ¶ï¼ˆå¯é€‰ï¼‰ |
| `bot-runtime/src/lib.rs` | ä¿®æ”¹ | 2,3,6 | æ¨¡å—å¯¼å‡º |
| `dbot-cli/src/main.rs` | ä¿®æ”¹ | 3 | ä¸»ç¨‹åºé›†æˆ |

### ğŸ” åŠŸèƒ½ç‰¹æ€§

| åŠŸèƒ½ | çŠ¶æ€ |
|------|------|
| @æåŠæ£€æµ‹ | âœ… |
| AIæ™ºèƒ½å›å¤ | âœ… |
| Handleré“¾æœºåˆ¶ | âœ… çœŸé“¾ |
| å¼‚æ­¥å¤„ç† | âœ… å¼‚æ­¥é˜Ÿåˆ— |
| æµå¼å“åº” | âœ… å¯é€‰ |
| é€Ÿç‡é™åˆ¶ | âœ… å¯é€‰ |
| å®Œæ•´æ¶ˆæ¯è®°å½• | âœ… ç”¨æˆ·+AI |
| åŠ¨æ€è·å–bot_username | âœ… |
| å¯æ‰©å±•æ€§ | âœ… é«˜ |

### ğŸ“Š æ¶æ„è®¾è®¡

```
ç”¨æˆ·æ¶ˆæ¯ â†’ HandlerChain
              â”œâ”€ AIDetectionHandler â†’ AIæŸ¥è¯¢é˜Ÿåˆ— â”€â”
              â”‚                                    â†“
              â””â”€ MessageHandler (è®°å½•)    AIQueryHandler
                                              â”œâ”€ é€Ÿç‡é™åˆ¶ï¼ˆå¯é€‰ï¼‰
                                              â”œâ”€ OpenAI (æ™®é€š/æµå¼ï¼‰
                                              â”œâ”€ å‘é€/ç¼–è¾‘æ¶ˆæ¯
                                              â””â”€ è®°å½•åˆ°æ•°æ®åº“
                                              â†‘ å¼‚æ­¥å¤„ç†ï¼Œä¸é˜»å¡ä¸»æµç¨‹
```

### âš ï¸ æ³¨æ„äº‹é¡¹

1. **å¼‚æ­¥å¤„ç†**ï¼šAIæŸ¥è¯¢åœ¨ç‹¬ç«‹ä»»åŠ¡ä¸­å¤„ç†ï¼Œä¸é˜»å¡ä¸»æ¶ˆæ¯æµç¨‹
2. **Tokenå®‰å…¨**ï¼šåˆ‡å‹¿å°†æ•æ„Ÿä¿¡æ¯æäº¤åˆ°ä»£ç ä»“åº“
3. **APIæˆæœ¬æ§åˆ¶**ï¼šå»ºè®®é…ç½®é€Ÿç‡é™åˆ¶ï¼ˆé˜¶æ®µå…­ï¼‰ï¼Œæ§åˆ¶APIè°ƒç”¨æˆæœ¬
4. **é€Ÿç‡é™åˆ¶å®šä½**ï¼šé€Ÿç‡é™åˆ¶ä»…é’ˆå¯¹ AI è°ƒç”¨ï¼Œä¸å½±å“æ™®é€šæ¶ˆæ¯å¤„ç†
5. **æµå¼å“åº”**ï¼šæµå¼å“åº”ä¼šé€šè¿‡ç¼–è¾‘æ¶ˆæ¯å®æ—¶æ›´æ–°ï¼Œé¿å…å‘é€å¤šæ¡æ¶ˆæ¯
6. **å¯é€‰åŠŸèƒ½**ï¼šå‰ä¸‰ä¸ªé˜¶æ®µå³å¯å®ç°å®Œæ•´åŠŸèƒ½ï¼Œæµå¼å“åº”å’Œé€Ÿç‡ä¸ºå¢å¼ºåŠŸèƒ½

### ğŸš€ å¿«é€Ÿå¼€å§‹

```bash
# 1. é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
# ç¼–è¾‘ .env å¡«å…¥ BOT_TOKEN å’Œ OPENAI_API_KEY

# 2. è¿è¡Œ bot
cargo run

# 3. åœ¨ Telegram ä¸­ @æåŠä½ çš„ bot æµ‹è¯•

# 4. (å¯é€‰) å¯ç”¨æµå¼å“åº”
# è®¾ç½® AI_USE_STREAMING=trueï¼ŒAI å›å¤å°†å®æ—¶æ˜¾ç¤º

# 5. (å¯é€‰) æ·»åŠ é€Ÿç‡é™åˆ¶
# å®Œæˆé˜¶æ®µå…­åï¼ŒAIè°ƒç”¨å°†å—åˆ°é€Ÿç‡é™åˆ¶ä¿æŠ¤
```

---

## æ¦‚è¿°

åœ¨ç°æœ‰ dbot-cli åŸºç¡€ä¸Šå®ç°ï¼šå½“ç”¨æˆ·åœ¨ Telegram ä¸­ @ æåŠ bot æ—¶ï¼Œä½¿ç”¨ OpenAI è¿›è¡Œæ™ºèƒ½å›å¤ã€‚

## æ¶æ„è®¾è®¡

### æ€»ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              Telegram ç”¨æˆ·                                      â”‚
â”‚                              å‘é€æ¶ˆæ¯ @bot                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            dbot-cli (ä¸»ç¨‹åº)                                     â”‚
â”‚                                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         ä¸»æ¶ˆæ¯å¾ªç¯ (teloxide::repl)                       â”‚   â”‚
â”‚  â”‚                                                                           â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚              HandlerChain (å¤„ç†å™¨é“¾)                        â”‚    â”‚   â”‚
â”‚  â”‚  â”‚                                                            â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  AIDetectionHandler (AIæ£€æµ‹å±‚)                       â”‚     â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”œâ”€ æ£€æµ‹ @bot æåŠ                                   â”‚     â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”œâ”€ æå–é—®é¢˜å†…å®¹                                    â”‚     â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”œâ”€ å‘é€åˆ° AI æŸ¥è¯¢é˜Ÿåˆ— (async)                       â”‚     â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â””â”€ è¿”å› Stop (åœæ­¢åç»­å¤„ç†)                         â”‚     â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚    â”‚   â”‚
â”‚  â”‚  â”‚           â”‚ (æœªæ£€æµ‹åˆ° @æåŠ)                              â”‚    â”‚   â”‚
â”‚  â”‚  â”‚           â”‚ Continue                                       â”‚    â”‚   â”‚
â”‚  â”‚  â”‚           â–¼                                                â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  MessageHandler (æ¶ˆæ¯è®°å½•å±‚)                        â”‚     â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â””â”€ ä¿å­˜ç”¨æˆ·æ¶ˆæ¯åˆ°æ•°æ®åº“                            â”‚     â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â””â”€ è¿”å› Ignore                                     â”‚     â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                      â”‚                                       â”‚
â”‚                                      â”‚ æ¶ˆæ¯å¤„ç†å®Œæˆ                           â”‚
â”‚                                      â”‚                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚           AIQueryHandler (å¼‚æ­¥ä»»åŠ¡ - ç‹¬ç«‹ tokio::spawn)          â”‚        â”‚
â”‚  â”‚                                                                   â”‚        â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚        â”‚
â”‚  â”‚  â”‚  run(): ä»é˜Ÿåˆ—æ¥æ”¶ AI æŸ¥è¯¢                                â”‚ â”‚        â”‚
â”‚  â”‚  â”‚  â”‚                                                          â”‚ â”‚        â”‚
â”‚  â”‚  â”‚  â”‚  AIQuery { chat_id, user_id, question }                   â”‚ â”‚        â”‚
â”‚  â”‚  â”‚  â”‚           â”‚                                              â”‚ â”‚        â”‚
â”‚  â”‚  â”‚  â”‚           â–¼                                              â”‚ â”‚        â”‚
â”‚  â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚ â”‚        â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  RateLimiter (é€Ÿç‡é™åˆ¶)                         â”‚    â”‚ â”‚        â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ æ£€æŸ¥ç”¨æˆ· AI è°ƒç”¨é¢‘ç‡                         â”‚    â”‚ â”‚        â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ è¶…é™ â†’ è·³è¿‡æœ¬æ¬¡å¤„ç†                          â”‚    â”‚ â”‚        â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â””â”€ æœªè¶…é™ â†’ ç»§ç»­å¤„ç†                            â”‚    â”‚ â”‚        â”‚
â”‚  â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ â”‚        â”‚
â”‚  â”‚  â”‚  â”‚           â”‚                                              â”‚ â”‚        â”‚
â”‚  â”‚  â”‚  â”‚           â–¼                                              â”‚ â”‚        â”‚
â”‚  â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚ â”‚        â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  TelegramBotAI (AI å¤„ç†æ¨¡å—)                     â”‚    â”‚ â”‚        â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â””â”€ è°ƒç”¨ OpenAI Streaming API (å¯é€‰)            â”‚    â”‚ â”‚        â”‚
â”‚  â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ â”‚        â”‚
â”‚  â”‚  â”‚  â”‚           â”‚                                              â”‚ â”‚        â”‚
â”‚  â”‚  â”‚  â”‚           â–¼                                              â”‚ â”‚        â”‚
â”‚  â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚ â”‚        â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  send_message(): å‘é€åˆå§‹æ¶ˆæ¯ "æ­£åœ¨æ€è€ƒ..."     â”‚    â”‚ â”‚        â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  edit_message(): æ”¶åˆ° chunk æ—¶ç¼–è¾‘æ¶ˆæ¯å†…å®¹ (å¯é€‰)â”‚    â”‚ â”‚        â”‚
â”‚  â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ â”‚        â”‚
â”‚  â”‚  â”‚  â”‚           â”‚                                              â”‚ â”‚        â”‚
â”‚  â”‚  â”‚  â”‚           â–¼                                              â”‚ â”‚        â”‚
â”‚  â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚ â”‚        â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  log_ai_response(): è®°å½•å®Œæ•´ AI å›å¤åˆ°æ•°æ®åº“     â”‚    â”‚ â”‚        â”‚
â”‚  â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ â”‚        â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              å¤–éƒ¨æœåŠ¡                                        â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   Telegram API      â”‚        â”‚      OpenAI API                  â”‚   â”‚
â”‚  â”‚                      â”‚        â”‚                                  â”‚   â”‚
â”‚  â”‚  - æ¥æ”¶ç”¨æˆ·æ¶ˆæ¯      â”‚        â”‚  - GPT æ¨¡å‹                      â”‚   â”‚
â”‚  â”‚  - å‘é€ AI å›å¤      â”‚        â”‚  - AI å¯¹è¯ç”Ÿæˆ                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              æ•°æ®å­˜å‚¨                                        â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                     SQLite æ•°æ®åº“                                â”‚    â”‚
â”‚  â”‚                                                                  â”‚    â”‚
â”‚  â”‚  messages è¡¨:                                                     â”‚    â”‚
â”‚  â”‚  â”œâ”€ ç”¨æˆ·æ¶ˆæ¯ (Incoming)                                          â”‚    â”‚
â”‚  â”‚  â””â”€ AI å›å¤   (Outgoing)                                          â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµæ¶æ„å›¾

```
åŒæ­¥æ¶ˆæ¯å¤„ç†æµç¨‹ (ä¸»çº¿ç¨‹)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ç”¨æˆ·æ¶ˆæ¯ @bot
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ HandlerChain (é¡ºåºæ‰§è¡Œ)                                              â”‚ â”‚
â”‚                                                                      â”‚ â”‚
â”‚  1. AIDetectionHandler                                              â”‚ â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚     â”‚ æ£€æµ‹ @bot                                                   â”‚   â”‚ â”‚
â”‚     â”‚   â”œâ”€ æ˜¯ â†’ æå–é—®é¢˜ â†’ å‘é€åˆ°é˜Ÿåˆ— â†’ STOP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚ â”‚
â”‚     â”‚   â”‚                                                     â”‚ â”‚   â”‚ â”‚
â”‚     â”‚   â””â”€ å¦ â†’ CONTINUE                                      â”‚ â”‚   â”‚ â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚                                â”‚                                    â”‚   â”‚
â”‚                                â”‚ (ä»…æœªæ£€æµ‹åˆ°@æ—¶)                     â”‚   â”‚
â”‚                                â–¼                                    â”‚   â”‚
â”‚                          2. MessageHandler                         â”‚
â”‚                             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚                             â”‚ ä¿å­˜ç”¨æˆ·æ¶ˆæ¯åˆ°æ•°æ®åº“             â”‚    â”‚   â”‚
â”‚                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚                                      â”‚ IGNORE                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
                                   æ¶ˆæ¯å¤„ç†å®Œæˆ


å¼‚æ­¥ AI å¤„ç†æµç¨‹ (ç‹¬ç«‹ä»»åŠ¡)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

AI æŸ¥è¯¢é˜Ÿåˆ— (mpsc::unbounded_channel)
    â”‚
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AIQueryHandler::run() (tokio::spawn)                               â”‚
â”‚                                                                     â”‚
â”‚  while let Some(query) = receiver.recv().await {                  â”‚
â”‚                                                                     â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚    â”‚ 1. æ¥æ”¶æŸ¥è¯¢:                                               â”‚   â”‚
â”‚    â”‚    AIQuery { chat_id, user_id, question }                  â”‚   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â”‚                                          â”‚
â”‚                           â–¼                                          â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚    â”‚ 2. é€Ÿç‡é™åˆ¶æ£€æŸ¥ (ä»… AI è°ƒç”¨)                               â”‚   â”‚
â”‚    â”‚   RateLimiter::check(user_id)                            â”‚   â”‚
â”‚    â”‚   â”œâ”€ è¶…é™ â†’ è·³è¿‡æœ¬æ¬¡å¤„ç†                                   â”‚   â”‚
â”‚    â”‚   â””â”€ æœªè¶…é™ â†’ ç»§ç»­                                        â”‚   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â”‚                                          â”‚
â”‚                           â–¼                                          â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚    â”‚ 3. è°ƒç”¨ OpenAI API (éæµå¼æˆ–æµå¼):                       â”‚   â”‚
â”‚    â”‚    TelegramBotAI::get_ai_response(question)              â”‚   â”‚
â”‚    â”‚    æˆ–                                                     â”‚   â”‚
â”‚    â”‚    TelegramBotAI::get_ai_response_stream(question, cb)    â”‚   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â”‚                                          â”‚
â”‚                           â–¼                                          â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚    â”‚ 4a. éæµå¼: å‘é€å®Œæ•´å›å¤                                  â”‚   â”‚
â”‚    â”‚    bot.send_message(chat_id, response)                  â”‚   â”‚
â”‚    â”‚                                                           â”‚   â”‚
â”‚    â”‚ 4b. æµå¼ (å¯é€‰): å®æ—¶æ›´æ–°æ¶ˆæ¯                             â”‚   â”‚
â”‚    â”‚    â”œâ”€ å‘é€åˆå§‹æ¶ˆæ¯: "æ­£åœ¨æ€è€ƒ..."                        â”‚   â”‚
â”‚    â”‚    â”œâ”€ æ”¶åˆ° chunk â†’ bot.edit_message(chat_id, msg_id, text)â”‚   â”‚
â”‚    â”‚    â””â”€ å®Œæˆ â†’ å®Œæ•´å†…å®¹å·²æ˜¾ç¤º                               â”‚   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â”‚                                          â”‚
â”‚                           â–¼                                          â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚    â”‚ 5. è®°å½•åˆ°æ•°æ®åº“:                                          â”‚   â”‚
â”‚    â”‚    log_ai_response(response)                             â”‚   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  }                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç»„ä»¶äº¤äº’æ—¶åºå›¾

```
ç”¨æˆ·      Telegram      bot      HandlerChain    é˜Ÿåˆ—    AIHandler    RateLimiter  OpenAI    æ•°æ®åº“
â”‚            â”‚            â”‚             â”‚            â”‚           â”‚         â”‚          â”‚          â”‚
â”œâ”€æ¶ˆæ¯â”€@botâ”€â†’â”‚            â”‚             â”‚            â”‚           â”‚         â”‚          â”‚          â”‚
â”‚            â”œâ”€æ¥æ”¶â”€â”€â”€â”€â”€â†’â”‚             â”‚            â”‚           â”‚         â”‚          â”‚          â”‚
â”‚            â”‚            â”œâ”€handle()â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚           â”‚         â”‚          â”‚          â”‚
â”‚            â”‚            â”‚             â”‚            â”œâ”€@æåŠ?â”€â”€â†’â”‚         â”‚          â”‚          â”‚
â”‚            â”‚            â”‚             â”‚            â”‚â†â”€Stopâ”€â”€â”€â”€â”¤         â”‚          â”‚          â”‚
â”‚            â”‚            â”‚             â”‚            â”‚           â”‚         â”‚          â”‚          â”‚
â”‚            â”‚            â”‚             â”‚            â”œâ”€send()â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚         â”‚          â”‚          â”‚
â”‚            â”‚            â”‚             â”‚            â”‚           â”‚         â”‚          â”‚          â”‚
â”‚            â”‚            â”‚             â”‚            â”‚â†â”€Continueâ”¤         â”‚          â”‚          â”‚
â”‚            â”‚            â”‚             â”‚            â”‚           â”‚         â”‚          â”‚          â”‚
â”‚            â”‚            â”‚             â”‚            â”œâ”€saveâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
â”‚            â”‚            â”‚             â”‚            â”‚           â”‚         â”‚          â”‚          â”‚
â”‚            â”‚            â”‚             â”‚            â”‚           â”‚â—„â”€recv()â”€â”¤          â”‚          â”‚
â”‚            â”‚            â”‚             â”‚            â”‚           â”‚         â”‚          â”‚          â”‚
â”‚            â”‚            â”‚             â”‚            â”‚           â”‚         â”œâ”€check()â”€â†’â”‚         â”‚          â”‚
â”‚            â”‚            â”‚             â”‚            â”‚           â”‚         â”‚â†â”€OKâ”€â”€â”€â”€â”€â”¤         â”‚          â”‚
â”‚            â”‚            â”‚             â”‚            â”‚           â”‚         â”‚          â”‚          â”‚
â”‚            â”‚            â”‚             â”‚            â”‚           â”‚         â”œâ”€APIè¯·æ±‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚          â”‚
â”‚            â”‚            â”‚             â”‚            â”‚           â”‚         â”‚         â”‚â†â”€streamâ†’â”‚          â”‚
â”‚            â”‚            â”‚             â”‚            â”‚           â”‚         â”‚         â”‚â†â”€chunkâ”€â†’â”‚          â”‚
â”‚            â”‚            â”‚             â”‚            â”‚           â”‚         â”‚         â”‚â†â”€AIå›å¤â”€â”¤          â”‚
â”‚            â”‚            â”‚             â”‚            â”‚           â”‚         â”‚         â”‚          â”‚          â”‚
â”‚            â”‚            â”‚             â”‚            â”‚           â”‚         â”œâ”€sendåˆå§‹"æ­£åœ¨..."â”€â”€â†’â”‚          â”‚
â”‚            â”‚            â”‚             â”‚            â”‚           â”‚         â”œâ”€editâ”€â”€chunkâ”€â”€â”€â”€â”€â”€â”€â†’â”‚          â”‚
â”‚            â”‚            â”‚             â”‚            â”‚           â”‚         â”œâ”€editâ”€â”€chunkâ”€â”€â”€â”€â”€â”€â”€â†’â”‚          â”‚
â”‚            â”‚            â”‚             â”‚            â”‚           â”‚         â”‚         â”‚          â”‚          â”‚
â”‚            â”‚            â”‚             â”‚            â”‚           â”‚         â”œâ”€saveå®Œæ•´å›å¤â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚          â”‚
â”‚            â”‚            â”‚             â”‚            â”‚           â”‚         â”‚         â”‚          â”‚          â”‚
â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€å›å¤â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚            â”‚            â”‚             â”‚            â”‚           â”‚         â”‚         â”‚          â”‚          â”‚
```

### ç³»ç»Ÿç‰¹æ€§è¯´æ˜

#### åŒæ­¥ vs å¼‚æ­¥å¤„ç†

| å¤„ç†ç±»å‹ | ç»„ä»¶ | ç‰¹ç‚¹ | è€—æ—¶ |
|---------|------|------|------|
| **åŒæ­¥** | AIDetectionHandler | å­—ç¬¦ä¸²åŒ¹é…ï¼Œæå¿« | < 1ms |
| **åŒæ­¥** | MessageHandler | æ•°æ®åº“å†™å…¥ï¼Œè¾ƒå¿« | 1-10ms |
| **å¼‚æ­¥** | AIQueryHandler (éæµå¼) | AI API è°ƒç”¨ï¼Œæ…¢ | 1-5s |
| **å¼‚æ­¥** | AIQueryHandler (æµå¼) | AI Streaming API | å®æ—¶æ›´æ–° |
| **å¼‚æ­¥** | RateLimiter (å¯é€‰) | å†…å­˜æ£€æŸ¥ï¼Œæå¿« | < 1ms |

#### é˜Ÿåˆ—æœºåˆ¶

```
æŸ¥è¯¢é˜Ÿåˆ— (mpsc::unbounded_channel)
    â”œâ”€ ç±»å‹: æ— ç•Œé€šé“ (unbounded)
    â”œâ”€ ä¼˜ç‚¹: ä¸ä¼šé˜»å¡å‘é€è€…
    â”œâ”€ ç¼ºç‚¹: å†…å­˜å¯èƒ½æ— é™å¢é•¿
    â””â”€ æ”¹è¿›: å¯è€ƒè™‘æœ‰ç•Œé€šé“ + èƒŒå‹æœºåˆ¶
```

#### å…³é”®è®¾è®¡å†³ç­–

1. **ä¸ºä»€ä¹ˆå¼‚æ­¥å¤„ç† AI?**
   - AI API è°ƒç”¨è€—æ—¶ 1-5 ç§’
   - é˜²æ­¢é˜»å¡ä¸»æ¶ˆæ¯å¾ªç¯
   - æå‡ç³»ç»Ÿååé‡

2. **ä¸ºä»€ä¹ˆåˆ†ç¦»æ£€æµ‹å’Œå¤„ç†?**
   - èŒè´£å•ä¸€ï¼Œæ˜“äºæµ‹è¯•
   - æ£€æµ‹å±‚å¯å¿«é€Ÿè¿”å›
   - å¤„ç†å±‚å¯ç‹¬ç«‹æ‰©å±•

3. **ä¸ºä»€ä¹ˆä½¿ç”¨ HandlerChain?**
    - å¯çµæ´»æ·»åŠ æ–° Handler
    - HandlerResponse æ§åˆ¶æµç¨‹
    - ä¾¿äºç»´æŠ¤å’Œæ‰©å±•

4. **ä¸ºä»€ä¹ˆæ”¯æŒæµå¼å“åº”?**
    - æå‡ç”¨æˆ·ä½“éªŒï¼Œå®æ—¶çœ‹åˆ° AI ç”Ÿæˆè¿‡ç¨‹
    - å‡å°‘ç­‰å¾…æ—¶é—´ï¼Œé™ä½ç„¦è™‘æ„Ÿ
    - æ›´ç¬¦åˆå¯¹è¯çš„è‡ªç„¶äº¤äº’ä½“éªŒ

5. **æµå¼å“åº”å®ç°æ–¹å¼**
    - å‘é€åˆå§‹æ¶ˆæ¯ï¼š"æ­£åœ¨æ€è€ƒ..."
    - æ”¶åˆ° chunk åä½¿ç”¨ `editMessageText` æ›´æ–°å†…å®¹
    - é¿å…å‘é€å¤šæ¡æ¶ˆæ¯ï¼Œä¿æŒèŠå¤©ç•Œé¢æ•´æ´

## æ ¸å¿ƒå®ç°

### æ–¹æ¡ˆæ¦‚è¿°

**é€‚ç”¨åœºæ™¯**ï¼šç”Ÿäº§ç¯å¢ƒã€é«˜å¹¶å‘ã€éœ€è¦å®Œæ•´åŠŸèƒ½

### æ ¸å¿ƒæ”¹è¿›

1. çœŸæ­£çš„Handleré“¾æœºåˆ¶
2. å¼‚æ­¥é˜Ÿåˆ—å¤„ç†AIæŸ¥è¯¢
3. å®Œæ•´çš„æ¶ˆæ¯è®°å½•
4. æ”¯æŒ AI æµå¼å“åº”ï¼ˆå¯é€‰ï¼‰
5. å¯é€‰çš„ AI è°ƒç”¨é€Ÿç‡é™åˆ¶ï¼ˆå¯é€‰é˜¶æ®µï¼‰

#### 1. Handleré“¾æœºåˆ¶å®ç°

**æ–°å»º**: `bot-runtime/src/handler_chain.rs`

```rust
use dbot_core::{Handler, HandlerResponse, Message, Result};
use std::sync::Arc;
use tracing::{info, debug, instrument};

#[derive(Clone)]
pub struct HandlerChain {
    handlers: Vec<Arc<dyn Handler>>,
}

impl HandlerChain {
    pub fn new() -> Self {
        Self { handlers: Vec::new() }
    }

    pub fn add_handler(mut self, handler: Arc<dyn Handler>) -> Self {
        self.handlers.push(handler);
        self
    }

    #[instrument(skip(self, message))]
    pub async fn handle(&self, message: &Message) -> Result<HandlerResponse> {
        let mut final_response = HandlerResponse::Continue;

        for handler in &self.handlers {
            let response = handler.handle(message).await?;
            debug!(
                handler = std::any::type_name_of_val(handler.as_ref()),
                response = ?response,
                "Handler processed"
            );

            match response {
                HandlerResponse::Stop => {
                    info!("Handler chain stopped");
                    final_response = response;
                    break;
                }
                HandlerResponse::Continue => {
                    continue;
                }
                HandlerResponse::Ignore => {
                    continue;
                }
            }
        }

        Ok(final_response)
    }
}
```

#### 2. AI Detection Handlerï¼ˆæ£€æµ‹å±‚ï¼‰

**æ–°å»º**: `bot-runtime/src/ai_detection_handler.rs`

```rust
use async_trait::async_trait;
use dbot_core::{Handler, HandlerResponse, Message, Result};
use std::sync::Arc;
use tracing::{info, debug, instrument};

#[derive(Clone)]
pub struct AIDetectionHandler {
    bot_username: Arc<tokio::sync::RwLock<Option<String>>>,
    query_sender: Arc<tokio::sync::mpsc::UnboundedSender<AIQuery>>,
}

#[derive(Debug, Clone)]
pub struct AIQuery {
    pub chat_id: i64,
    pub user_id: i64,
    pub question: String,
}

impl AIDetectionHandler {
    pub fn new(
        bot_username: Arc<tokio::sync::RwLock<Option<String>>>,
        query_sender: Arc<tokio::sync::mpsc::UnboundedSender<AIQuery>>,
    ) -> Self {
        Self {
            bot_username,
            query_sender,
        }
    }

    async fn get_bot_username(&self) -> Option<String> {
        self.bot_username.read().await.clone()
    }

    async fn set_bot_username(&self, username: String) {
        *self.bot_username.write().await = Some(username);
    }

    fn is_bot_mentioned(&self, text: &str, bot_username: &str) -> bool {
        text.contains(&format!("@{}", bot_username))
    }

    fn extract_question(&self, text: &str, bot_username: &str) -> String {
        text.replace(&format!("@{}", bot_username), "")
            .trim()
            .to_string()
    }
}

#[async_trait]
impl Handler for AIDetectionHandler {
    #[instrument(skip(self, message))]
    async fn handle(&self, message: &Message) -> Result<HandlerResponse> {
        if let Some(bot_username) = self.get_bot_username().await {
            if self.is_bot_mentioned(&message.content, &bot_username) {
                let question = self.extract_question(&message.content, &bot_username);

                if !question.is_empty() {
                    info!(
                        user_id = message.user.id,
                        question = %question,
                        "Bot mentioned, sending to AI queue"
                    );

                    let query = AIQuery {
                        chat_id: message.chat.id,
                        user_id: message.user.id,
                        question,
                    };

                    self.query_sender
                        .send(query)
                        .map_err(|e| dbot_core::DbotError::Bot(format!("Failed to send AI query: {}", e)))?;

                    return Ok(HandlerResponse::Stop);
                }
            }
        }

        Ok(HandlerResponse::Continue)
    }
}
```

#### 3. AI Query Handlerï¼ˆAIå¤„ç†å±‚ï¼‰

**æ–°å»º**: `bot-runtime/src/ai_query_handler.rs`

```rust
use dbot_core::Message;
use telegram_bot_ai::TelegramBotAI;
use openai_client::OpenAIClient;
use storage::MessageRepository;
use tokio::sync::mpsc::UnboundedReceiver;
use tracing::{info, error, debug};
use teloxide::Bot;
use std::sync::Arc;

pub struct AIQueryHandler {
    ai_bot: TelegramBotAI,
    bot: Arc<Bot>,
    repo: MessageRepository,
    receiver: UnboundedReceiver<AIDetectionHandler::AIQuery>,
}

impl AIQueryHandler {
    pub fn new(
        ai_bot: TelegramBotAI,
        bot: Bot,
        repo: MessageRepository,
        receiver: UnboundedReceiver<AIDetectionHandler::AIQuery>,
    ) -> Self {
        Self {
            ai_bot,
            bot: Arc::new(bot),
            repo,
            receiver,
        }
    }

    pub async fn run(&mut self) {
        while let Some(query) = self.receiver.recv().await {
            self.handle_query(query).await;
        }
    }

    async fn handle_query(&self, query: AIDetectionHandler::AIQuery) {
        info!(
            user_id = query.user_id,
            question = %query.question,
            "Processing AI query"
        );

        match self.ai_bot.get_ai_response(&query.question).await {
            Ok(response) => {
                if let Err(e) = self.send_response(&query, &response).await {
                    error!(error = %e, "Failed to send AI response");
                }
            }
            Err(e) => {
                error!(error = %e, "Failed to get AI response");
                let error_msg = "æŠ±æ­‰ï¼Œå¤„ç†æ‚¨çš„è¯·æ±‚æ—¶å‡ºé”™ï¼Œè¯·ç¨åé‡è¯•ã€‚";
                let _ = self.send_response(&query, error_msg).await;
            }
        }
    }

    async fn send_response(&self, query: &AIDetectionHandler::AIQuery, response: &str) -> Result<()> {
        let chat_id = teloxide::types::ChatId(query.chat_id);

        self.bot
            .send_message(chat_id, response)
            .await
            .map_err(|e| {
                error!(error = %e, "Failed to send message");
                dbot_core::DbotError::Bot(e.to_string())
            })?;

        self.log_ai_response(query, response).await?;

        info!(user_id = query.user_id, "AI response sent");
        Ok(())
    }

    async fn log_ai_response(&self, query: &AIDetectionHandler::AIQuery, response: &str) -> Result<()> {
        let record = storage::MessageRecord::new(
            query.user_id,
            query.chat_id,
            None,
            None,
            None,
            "ai_response".to_string(),
            response.to_string(),
            "sent".to_string(),
        );

        self.repo
            .save(&record)
            .await
            .map_err(|e| {
                error!(error = %e, "Failed to save AI response");
                dbot_core::DbotError::Database(e.to_string())
            })?;

        Ok(())
    }
}
```

#### 3. Rate Limit Middleware

**æ–°å»º**: `bot-runtime/src/rate_limit.rs`

```rust
use async_trait::async_trait;
use dbot_core::{Middleware, Message, Result};
use std::collections::HashMap;
use std::time::{Duration, Instant};
use tokio::sync::Mutex;
use tracing::{warn, info};

#[derive(Clone)]
pub struct RateLimitConfig {
    pub max_requests: usize,
    pub window_duration: Duration,
}

impl Default for RateLimitConfig {
    fn default() -> Self {
        Self {
            max_requests: 10,
            window_duration: Duration::from_secs(60),
        }
    }
}

#[derive(Clone)]
pub struct RateLimitMiddleware {
    config: RateLimitConfig,
    requests: Arc<Mutex<HashMap<i64, Vec<Instant>>>>,
}

impl RateLimitMiddleware {
    pub fn new(config: RateLimitConfig) -> Self {
        Self {
            config,
            requests: Arc::new(Mutex::new(HashMap::new())),
        }
    }

    async fn is_rate_limited(&self, user_id: i64) -> bool {
        let now = Instant::now();
        let mut requests = self.requests.lock().await;

        let user_requests = requests.entry(user_id).or_insert_with(Vec::new);

        user_requests.retain(|&t| now.duration_since(t) < self.config.window_duration);

        if user_requests.len() >= self.config.max_requests {
            warn!(
                user_id = user_id,
                requests = user_requests.len(),
                "User rate limited"
            );
            true
        } else {
            user_requests.push(now);
            false
        }
    }
}

#[async_trait]
impl Middleware for RateLimitMiddleware {
    #[instrument(skip(self, message))]
    async fn before(&self, message: &Message) -> Result<bool> {
        if self.is_rate_limited(message.user.id).await {
            info!(user_id = message.user.id, "Message blocked by rate limit");
            Ok(false)
        } else {
            Ok(true)
        }
    }

    async fn after(&self, _message: &Message, _response: &HandlerResponse) -> Result<()> {
        Ok(())
    }
}
```

#### 4. æ›´æ–° bot-runtime/src/lib.rs

```rust
pub mod handler;
pub mod state;
pub mod middleware;
pub mod handler_chain;
pub mod ai_detection_handler;
pub mod ai_query_handler;
pub mod rate_limit;

pub use handler::MessageHandler;
pub use state::StateManager;
pub use handler_chain::HandlerChain;
pub use ai_detection_handler::{AIDetectionHandler, AIQuery};
pub use rate_limit::{RateLimitMiddleware, RateLimitConfig};
```

#### 6. æ›´æ–° dbot-cli/src/main.rs

```rust
use anyhow::Result;
use clap::Parser;
use teloxide::prelude::*;
use dbot_core::{Chat, Message, User, MessageDirection, ToCoreMessage, ToCoreUser, Handler, init_tracing};
use bot_runtime::{MessageHandler, StateManager, HandlerChain, AIDetectionHandler, RateLimitMiddleware, RateLimitConfig};
use storage::MessageRepository;
use std::sync::Arc;
use telegram_bot_ai::TelegramBotAI;
use openai_client::OpenAIClient;
use tracing::{info, instrument, error};

#[derive(Parser)]
#[command(name = "dbot")]
#[command(about = "è¿è¡Œ Telegram Bot", long_about = None)]
#[command(version)]
struct Cli {
    #[arg(short, long)]
    token: Option<String>,
}

#[tokio::main]
async fn main() -> Result<()> {
    dotenvy::dotenv().ok();
    let cli = Cli::parse();
    run_bot(cli.token).await
}

#[instrument(skip(token))]
async fn run_bot(token: Option<String>) -> Result<()> {
    let log_file = "logs/telegram-bot.log";
    std::fs::create_dir_all("logs").expect("Failed to create logs directory");
    init_tracing(log_file)?;

    let bot_token = token.unwrap_or_else(|| {
        std::env::var("BOT_TOKEN").expect("BOT_TOKEN not set")
    });

    let database_url =
        std::env::var("DATABASE_URL").unwrap_or_else(|_| "file:./telegram_bot.db".to_string());

    let openai_api_key = std::env::var("OPENAI_API_KEY").expect("OPENAI_API_KEY not set");
    let openai_base_url = std::env::var("OPENAI_BASE_URL")
        .unwrap_or_else(|_| "https://api.openai.com/v1".to_string());

    let rate_limit_max: usize = std::env::var("RATE_LIMIT_MAX_REQUESTS")
        .ok()
        .and_then(|s| s.parse().ok())
        .unwrap_or(10);
    let rate_limit_window_secs: u64 = std::env::var("RATE_LIMIT_WINDOW_SECS")
        .ok()
        .and_then(|s| s.parse().ok())
        .unwrap_or(60);

    info!(database_url = %database_url, "Initializing bot");

    let repo = Arc::new(
        MessageRepository::new(&database_url)
            .await
            .map_err(|e| {
                error!(error = %e, database_url = %database_url, "Failed to initialize message storage");
                e
            })
            .expect("Failed to initialize message storage"),
    );

    let teloxide_bot = Bot::new(bot_token.clone());

    let bot_username = Arc::new(tokio::sync::RwLock::new(None));

    let (query_sender, query_receiver) = tokio::sync::mpsc::unbounded_channel();

    let openai_client = OpenAIClient::with_base_url(openai_api_key, openai_base_url);
    let ai_bot = TelegramBotAI::new("bot".to_string(), openai_client);

    let mut ai_query_handler = bot_runtime::AIQueryHandler::new(
        ai_bot,
        teloxide_bot.clone(),
        repo.as_ref().clone(),
        query_receiver,
    );

    tokio::spawn(async move {
        ai_query_handler.run().await;
    });

    let ai_detection_handler = Arc::new(AIDetectionHandler::new(
        bot_username.clone(),
        Arc::new(query_sender),
    ));

    let rate_limit_middleware = Arc::new(RateLimitMiddleware::new(RateLimitConfig {
        max_requests: rate_limit_max,
        window_duration: Duration::from_secs(rate_limit_window_secs),
    }));

    let message_handler = Arc::new(MessageHandler::new(repo.as_ref().clone()));

    let handler_chain = HandlerChain::new()
        .add_handler(ai_detection_handler)
        .add_handler(message_handler);

    let state_manager = StateManager::new();

    info!("Bot started successfully");

    let mut bot_username_ref = bot_username.clone();
    tokio::spawn(async move {
        if let Ok(me) = teloxide_bot.get_me().await {
            *bot_username_ref.write().await = Some(me.user.username);
            info!(username = %me.user.username, "Bot username set");
        }
    });

    teloxide::repl(teloxide_bot, move |_bot: Bot, msg: teloxide::types::Message| {
        let handler_chain = handler_chain.clone();
        let rate_limit_middleware = rate_limit_middleware.clone();

        async move {
            if let Some(text) = msg.text() {
                let wrapper = TelegramMessageWrapper(&msg);
                let core_msg = wrapper.to_core();

                info!(
                    user_id = core_msg.user.id,
                    message_content = %text,
                    "Received message"
                );

                if let Err(e) = rate_limit_middleware.before(&core_msg).await {
                    error!(error = %e, user_id = core_msg.user.id, "Rate limit check failed");
                    return Ok(());
                }

                match handler_chain.handle(&core_msg).await {
                    Ok(_) => {}
                    Err(e) => {
                        error!(error = %e, user_id = core_msg.user.id, "Handler chain failed");
                    }
                }

                let _ = rate_limit_middleware.after(&core_msg, &dbot_core::HandlerResponse::Ignore).await;
            }
            Ok(())
        }
    })
    .await;

    Ok(())
}

struct TelegramUserWrapper<'a>(&'a teloxide::types::User);

impl<'a> ToCoreUser for TelegramUserWrapper<'a> {
    fn to_core(&self) -> User {
        User {
            id: self.0.id.0 as i64,
            username: self.0.username.clone(),
            first_name: Some(self.0.first_name.clone()),
            last_name: self.0.last_name.clone(),
        }
    }
}

struct TelegramMessageWrapper<'a>(&'a teloxide::types::Message);

impl<'a> ToCoreMessage for TelegramMessageWrapper<'a> {
    fn to_core(&self) -> Message {
        Message {
            id: self.0.id.to_string(),
            user: self.0.from.as_ref()
                .map(|u| TelegramUserWrapper(u).to_core())
                .unwrap_or_else(|| User {
                    id: 0,
                    username: None,
                    first_name: None,
                    last_name: None,
                }),
            chat: Chat {
                id: self.0.chat.id.0,
                chat_type: format!("{:?}", self.0.chat.kind),
            },
            content: self.0.text().unwrap_or("").to_string(),
            message_type: "text".to_string(),
            direction: MessageDirection::Incoming,
            created_at: chrono::Utc::now(),
        }
    }
}
```

#### 7. æ›´æ–° dbot-cli/Cargo.toml

```toml
[dependencies]
dbot-core = { path = "../dbot-core" }
bot-runtime = { path = "../bot-runtime" }
storage = { path = "../storage" }
telegram-bot-ai = { path = "../telegram-bot-ai" }
openai-client = { path = "../openai-client" }
teloxide = { version = "0.12", features = ["macros"] }
anyhow = "1.0"
clap = { version = "4.4", features = ["derive"] }
tokio = { version = "1", features = ["full"] }
tracing = "0.1"
tracing-subscriber = { version = "0.3", features = ["env-filter", "json"] }
dotenvy = "0.15"
chrono = "0.4"
```

## é…ç½®è¦æ±‚

```env
# Telegram Bot é…ç½®
BOT_TOKEN=your_bot_token

# OpenAI é…ç½®
OPENAI_API_KEY=your_openai_api_key
OPENAI_BASE_URL=https://api.openai.com/v1

# æ•°æ®åº“é…ç½®
DATABASE_URL=file:./telegram_bot.db

# æµå¼å“åº”é…ç½®ï¼ˆå¯é€‰ï¼‰
AI_USE_STREAMING=true                       # æ˜¯å¦å¯ç”¨æµå¼å“åº”
AI_THINKING_MESSAGE=æ­£åœ¨æ€è€ƒ...             # åˆå§‹æç¤ºæ–‡æœ¬

# é€Ÿç‡é™åˆ¶é…ç½®ï¼ˆå¯é€‰ï¼‰
RATE_LIMIT_MAX_REQUESTS=10                  # é€Ÿç‡é™åˆ¶è¯·æ±‚æ•°
RATE_LIMIT_WINDOW_SECS=60                   # é€Ÿç‡é™åˆ¶çª—å£ï¼ˆç§’ï¼‰

# æ—¥å¿—çº§åˆ«
RUST_LOG=info
```

## æ•°æ®æµ

### æ•°æ®æµ

```
1. ç”¨æˆ·å‘é€æ¶ˆæ¯åˆ° Telegram
   â†“
2. teloxide æ¥æ”¶æ¶ˆæ¯
   â†“
3. è½¬æ¢ä¸º Message å¯¹è±¡
   â†“
4. HandlerChain ä¾æ¬¡å¤„ç†
   â”œâ”€ AIDetectionHandler
   â”‚   â”œâ”€ æ£€æµ‹æ˜¯å¦ @ æåŠ bot
   â”‚   â”œâ”€ æ˜¯ï¼šå‘é€åˆ° AI æŸ¥è¯¢é˜Ÿåˆ—ï¼Œè¿”å› Stop
   â”‚   â””â”€ å¦ï¼šè¿”å› Continue
   â”œâ”€ MessageHandler
   â”‚   â”œâ”€ ä¿å­˜æ¶ˆæ¯åˆ°æ•°æ®åº“
   â”‚   â””â”€ è¿”å› Ignore
   â†“
5. AIQueryHandlerï¼ˆå¼‚æ­¥ä»»åŠ¡ï¼‰
   â”œâ”€ ä»é˜Ÿåˆ—æ¥æ”¶æŸ¥è¯¢
   â”œâ”€ é€Ÿç‡é™åˆ¶æ£€æŸ¥ï¼ˆå¯é€‰ï¼‰
   â”œâ”€ è°ƒç”¨ OpenAI APIï¼ˆæ™®é€šæˆ–æµå¼ï¼‰
   â”œâ”€ å‘é€/ç¼–è¾‘ AI å›å¤
   â””â”€ è®°å½•åˆ°æ•°æ®åº“
```

## Handler å“åº”è¯´æ˜

- `HandlerResponse::Stop`: åœæ­¢åç»­ Handler å¤„ç†
- `HandlerResponse::Continue`: ç»§ç»­åç»­ Handler å¤„ç†
- `HandlerResponse::Ignore`: æ¶ˆæ¯å·²å¤„ç†å®Œæˆï¼Œä¸å½±å“æµç¨‹

## æ¶æ„ä¼˜åŠ¿

1. **å…³æ³¨ç‚¹åˆ†ç¦»**
   - æ£€æµ‹ã€å¤„ç†ã€å‘é€ã€è®°å½•å„å¸å…¶èŒ
   - æ˜“äºæµ‹è¯•å’Œç»´æŠ¤

2. **å¼‚æ­¥å¤„ç†**
   - AIæŸ¥è¯¢åœ¨ç‹¬ç«‹ä»»åŠ¡ä¸­å¤„ç†
   - ä¸é˜»å¡ä¸»æ¶ˆæ¯å¤„ç†æµç¨‹

3. **å®Œæ•´çš„Handleré“¾**
   - HandlerResponseçœŸæ­£èµ·ä½œç”¨
   - å¯ä»¥çµæ´»æ§åˆ¶å¤„ç†æµç¨‹

4. **é€Ÿç‡é™åˆ¶ä¿æŠ¤**
    - é˜²æ­¢APIæ»¥ç”¨
    - ä¿æŠ¤ç³»ç»Ÿç¨³å®šæ€§

5. **æµå¼å“åº”ä½“éªŒ**
    - å®æ—¶æ˜¾ç¤º AI ç”Ÿæˆè¿‡ç¨‹
    - å‡å°‘ç”¨æˆ·ç­‰å¾…ç„¦è™‘
    - æå‡äº¤äº’è‡ªç„¶åº¦

6. **æµå¼å“åº”ä½“éªŒ**
    - å®æ—¶æ˜¾ç¤º AI ç”Ÿæˆè¿‡ç¨‹
    - å‡å°‘ç”¨æˆ·ç­‰å¾…ç„¦è™‘
    - æå‡äº¤äº’è‡ªç„¶åº¦

7. **å®Œæ•´çš„æ¶ˆæ¯è®°å½•**
   - è®°å½•ç”¨æˆ·æ¶ˆæ¯å’ŒAIå›å¤
   - ä¾¿äºå®¡è®¡å’Œåˆ†æ

6. **åŠ¨æ€é…ç½®**
    - bot_usernameä»APIè·å–
    - é€Ÿç‡é™åˆ¶å¯é…ç½®
    - æµå¼å“åº”å¯å¼€å…³

7. **æ¨¡å—åŒ–è®¾è®¡**
   - å¤ç”¨ç°æœ‰æ¨¡å—
   - ä¸å½±å“ç°æœ‰åŠŸèƒ½

8. **ç±»å‹å®‰å…¨**
   - åŸºäºRustç±»å‹ç³»ç»Ÿ
   - å®Œæ•´çš„é”™è¯¯å¤„ç†

## æµ‹è¯•å»ºè®®

### å•å…ƒæµ‹è¯•
1. HandlerChainçš„æ‰§è¡Œé¡ºåº
2. æµå¼å“åº”é€»è¾‘
3. é€Ÿç‡é™åˆ¶é€»è¾‘
4. @æåŠæ£€æµ‹
5. é—®é¢˜æå–

### é›†æˆæµ‹è¯•
1. å®Œæ•´çš„AIå›å¤æµç¨‹ï¼ˆéæµå¼ï¼‰
2. å®Œæ•´çš„AIå›å¤æµç¨‹ï¼ˆæµå¼ï¼‰
3. å¼‚æ­¥é˜Ÿåˆ—å¤„ç†
4. æ•°æ®åº“è®°å½•
5. é”™è¯¯å¤„ç†
6. æµå¼æ¶ˆæ¯ç¼–è¾‘

### æ€§èƒ½æµ‹è¯•
1. é«˜å¹¶å‘åœºæ™¯
2. æµå¼å“åº”æ€§èƒ½
3. é€Ÿç‡é™åˆ¶ç”Ÿæ•ˆæ€§
4. é˜Ÿåˆ—å †ç§¯å¤„ç†
5. å“åº”æ—¶é—´ï¼ˆæ™®é€š vs æµå¼ï¼‰

### æ‰‹åŠ¨æµ‹è¯•
1. åœ¨Telegramä¸­@æåŠbot
2. éªŒè¯AIå›å¤æ˜¯å¦æ­£ç¡®
3. éªŒè¯æµå¼å“åº”æ˜¯å¦æ­£å¸¸ï¼ˆå¯é€‰ï¼‰
4. éªŒè¯æ¶ˆæ¯æ˜¯å¦è¢«è®°å½•åˆ°æ•°æ®åº“
5. æµ‹è¯•é€Ÿç‡é™åˆ¶ï¼ˆå¯é€‰ï¼‰
6. æµ‹è¯•æµå¼å“åº”åˆ‡æ¢ï¼ˆå¯é€‰ï¼‰

## åç»­ä¼˜åŒ–æ–¹å‘

1. **å¯¹è¯ä¸Šä¸‹æ–‡**
    - ä»æ•°æ®åº“è·å–å†å²æ¶ˆæ¯
    - æ”¯æŒå¤šè½®å¯¹è¯
    - æ·»åŠ è®°å¿†ç®¡ç†

2. **æ¶ˆæ¯å‘é€é˜Ÿåˆ—**
    - å¤„ç†å‘é€å¤±è´¥
    - è‡ªåŠ¨é‡è¯•æœºåˆ¶
    - æŒ‡æ•°é€€é¿ç­–ç•¥
    - æ”¯æŒä¼˜å…ˆçº§é˜Ÿåˆ—

3. **ç¼“å­˜æœºåˆ¶**
    - ç›¸ä¼¼é—®é¢˜ç¼“å­˜
    - å‡å°‘ API è°ƒç”¨
    - é™ä½æˆæœ¬
    - æ”¯æŒ Redis é›†æˆ

4. **ç›‘æ§å’Œå‘Šè­¦**
    - API ä½¿ç”¨é‡ç›‘æ§
    - å¼‚å¸¸æƒ…å†µå‘Šè­¦
    - æ€§èƒ½æŒ‡æ ‡æ”¶é›†
    - Prometheus é›†æˆ

5. **ç”¨æˆ·æƒé™ç®¡ç†**
    - ç™½åå•/é»‘åå•
    - åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶
    - æ”¯æŒç¾¤ç»„ç®¡ç†

6. **å¤šæ¨¡å‹æ”¯æŒ**
    - æ”¯æŒåˆ‡æ¢ä¸åŒ AI æ¨¡å‹
    - æ ¹æ®é—®é¢˜å¤æ‚åº¦è‡ªåŠ¨é€‰æ‹©
    - æ”¯æŒ GPT-4ã€Claude ç­‰

7. **Markdown æ”¯æŒ**
    - æ”¯æŒ Markdown æ ¼å¼æ¸²æŸ“
    - ä»£ç å—è¯­æ³•é«˜äº®
    - æ”¯æŒå›¾ç‰‡ã€é“¾æ¥ç­‰

8. **æœ‰ç•Œé˜Ÿåˆ—ä¼˜åŒ–**
    - ä» unbounded æ”¹ä¸ºæœ‰ç•Œé€šé“
    - å®ç°èƒŒå‹æœºåˆ¶
    - é˜²æ­¢å†…å­˜æº¢å‡º
   - å‡å°‘APIè°ƒç”¨
   - é™ä½æˆæœ¬

5. **ç›‘æ§å’Œå‘Šè­¦**
   - APIä½¿ç”¨é‡ç›‘æ§
   - å¼‚å¸¸æƒ…å†µå‘Šè­¦
   - æ€§èƒ½æŒ‡æ ‡æ”¶é›†

6. **å‘½ä»¤å‰ç¼€æ”¯æŒ**
   - æ·»åŠ  `/ai` æˆ– `/ask` å‘½ä»¤
   - ç§èŠæ¨¡å¼è‡ªåŠ¨å›å¤

7. **ç”¨æˆ·æƒé™ç®¡ç†**
   - ç™½åå•/é»‘åå•
   - åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶

8. **å¤šæ¨¡å‹æ”¯æŒ**
   - æ”¯æŒåˆ‡æ¢ä¸åŒAIæ¨¡å‹
   - æ ¹æ®é—®é¢˜å¤æ‚åº¦è‡ªåŠ¨é€‰æ‹©

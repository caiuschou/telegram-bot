# 实现计划

## 方案对比

| 特性 | Lance | 内存+SQLite | HNSW |
|------|-------|-------------|------|
| 性能 | ⭐⭐⭐⭐⭐ | ⭐⭐ | ⭐⭐⭐⭐ |
| 易用性 | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ |
| 规模 | 100万+ | <1万 | 10万+ |
| 依赖 | Lance | 无 | HNSW |
| 持久化 | ✅ | 需额外实现 | ✅ |
| 元数据过滤 | ✅ | 需手动实现 | ❌ |

## 推荐路线

- **小规模/原型**：内存+SQLite
- **生产环境**：Lance

## 分阶段实现

### 阶段1：基础记忆功能（内存+SQLite方案）

**目标**：实现核心记忆存储和检索功能

**任务**：
1. 创建 `memory` crate
2. 实现MemoryStore trait和基础方法
3. 实现OpenAI嵌入服务
4. 实现InMemoryVectorStore（简单余弦相似度）
5. 集成现有的storage模块（SQLite）
6. 编写单元测试

**验收标准**：
- 可以添加记忆条目
- 可以按用户检索记忆
- 可以进行语义搜索
- 单元测试覆盖率 > 80%

**预估时间**：1-2天

### 阶段2：上下文构建

**目标**：实现智能上下文构建器

**任务**：
1. 实现ContextBuilder
2. 实现多种上下文策略（最近、相关、偏好）
3. 实现上下文窗口管理
4. 编写测试用例

**验收标准**：
- 可以构建包含最近对话的上下文
- 可以构建包含相关历史的上下文
- 可以构建包含用户偏好的上下文
- 可以限制上下文token数量

**预估时间**：1天

### 阶段3：中间件集成

**目标**：将记忆功能集成到现有系统

**任务**：
1. 在 `bot-runtime` 实现MemoryMiddleware
2. 在 `telegram-bot-ai` 集成记忆功能
3. 实现消息处理流程
4. 编写集成测试

**验收标准**：
- 消息自动保存到记忆库
- AI回复自动保存到记忆库
- 上下文自动注入到提示词
- 完整对话流程测试通过

**预估时间**：2天

### 阶段4：Lance集成（可选，生产环境）

**目标**：实现高性能向量存储

**任务**：
1. 实现LanceVectorStore
2. 实现向量索引创建
3. 实现批量导入优化
4. 迁移测试数据到Lance

**验收标准**：
- 可以使用Lance存储记忆
- 向量索引正确创建
- 批量导入性能达标
- 数据迁移无丢失

**预估时间**：3-5天

### 阶段5：优化和增强

**目标**：提升性能和用户体验

**任务**：
1. 实现用户偏好提取
2. 实现重要信息标记
3. 添加对话总结（压缩长对话）
4. 性能优化（批量向量化、缓存）

**验收标准**：
- 可以自动识别用户偏好
- 可以标记重要信息
- 长对话自动总结
- 检索响应时间 < 200ms

**预估时间**：2-3天

## 开发计划表

| 阶段 | 任务 | 预估时间 | 依赖 |
|------|------|---------|------|
| 阶段1 | 基础记忆功能 | 1-2天 | 无 |
| 阶段2 | 上下文构建 | 1天 | 阶段1 |
| 阶段3 | 中间件集成 | 2天 | 阶段1,2 |
| 阶段4 | Lance集成 | 3-5天 | 阶段1,2,3 |
| 阶段5 | 优化和增强 | 2-3天 | 阶段1,2,3,4 |

**总计**：9-13天（不含阶段4则为4-7天）

# RAG 功能开发计划

## 项目概述

**项目名称**: RAG (Retrieval-Augmented Generation) 集成
**目标**: 为 dbot 项目集成 RAG 能力，实现对话记忆管理和上下文构建
**技术栈**: Rust, OpenAI API, Lance/SQLite
**总工期**: 9-13 天（不含 Lance 集成则为 4-7 天）

## 开发阶段

### 阶段 1: 基础记忆功能（内存+SQLite方案）

**目标**: 实现核心记忆存储和检索功能
**工期**: 1-2 天
**优先级**: P0（必须）

#### 任务列表

| ID | 任务 | 工时 | 依赖 | 状态 | 验收标准 |
|----|------|------|------|------|----------|
| 1.1 | 创建 memory crate 项目结构 | 1h | 无 | 已完成 | Cargo.toml 配置完成，基础目录结构创建 |
| 1.2 | 定义核心类型（MemoryEntry, MemoryMetadata, MemoryRole） | 2h | 1.1 | 已完成 | types.rs 完成，包含所有核心类型定义 |
| 1.3 | 实现 MemoryStore trait | 2h | 1.2 | 已完成 | trait 定义包含所有必需方法 |
| 1.4 | 实现 OpenAI 嵌入服务 | 3h | 1.3 | 已完成 | EmbeddingService trait 和 OpenAIEmbedding 实现 |
| 1.5 | 实现 InMemoryVectorStore | 4h | 1.4 | 已完成 | 完整的内存向量存储实现 |
| 1.6 | 集成现有 storage 模块（SQLite） | 2h | 1.5 | 已完成 | 持久化功能正常工作 |
| 1.7 | 编写单元测试 | 4h | 1.6 | 已完成 | 测试覆盖率 > 80% |
| 1.8 | 阶段测试和修复 | 2h | 1.7 | 已完成 | 所有测试通过，功能验证 |

**总计**: 20 工时（约 2-3 天）

---

### 阶段 2: 上下文构建

**目标**: 实现智能上下文构建器
**工期**: 1 天
**优先级**: P0（必须）
**依赖**: 阶段 1

#### 任务列表

| ID | 任务 | 工时 | 依赖 | 状态 | 验收标准 |
|----|------|------|------|------|----------|
| 2.1 | 设计 ContextBuilder 结构 | 1h | 1.8 | 已完成 | 设计文档完成 |
| 2.2 | 实现 ContextBuilder 基础结构 | 2h | 2.1 | 已完成 | context.rs 基础实现 |
| 2.3 | 实现最近对话上下文策略 | 2h | 2.2 | 已完成 | 可以获取最近 N 条对话 |
| 2.4 | 实现相关历史上下文策略 | 2h | 2.3 | 已完成 | 可以基于语义搜索相关历史 |
| 2.5 | 实现用户偏好上下文策略 | 1h | 2.4 | 已完成 | 可以获取用户偏好信息 |
| 2.6 | 实现上下文窗口管理 | 2h | 2.5 | 已完成 | 可以限制上下文 token 数量 |
| 2.7 | 编写测试用例 | 2h | 2.6 | 已完成 | 各种上下文策略测试通过 |
| 2.8 | 阶段测试和修复 | 2h | 2.7 | 已完成 | 所有测试通过 |

**总计**: 14 工时（约 2 天）

---

### 阶段 3: 中间件集成

**目标**: 将记忆功能集成到现有系统
**工期**: 2 天
**优先级**: P0（必须）
**依赖**: 阶段 1, 2

#### 任务列表

| ID | 任务 | 工时 | 依赖 | 状态 | 验收标准 |
|----|------|------|------|------|----------|
| 3.1 | 在 bot-runtime 创建 memory_middleware.rs | 1h | 1.8, 2.8 | 已完成 | 中间件基础结构创建 |
| 3.2 | 实现 Middleware trait | 2h | 3.1 | 已完成 | MemoryMiddleware 实现 |
| 3.3 | 实现消息保存逻辑 | 2h | 3.2 | 已完成 | 用户消息自动保存 |
| 3.4 | 实现上下文检索逻辑 | 2h | 3.3 | 部分完成 | 自动检索相关上下文（有编译错误需修复） |
| 3.5 | 在 ai-integration 扩展 TelegramBotAI | 2h | 3.4 | 待开始 | AI Bot 支持记忆功能 |
| 3.6 | 实现消息处理流程 | 3h | 3.5 | 待开始 | 完整的消息处理链路 |
| 3.7 | 实现 AI 回复保存逻辑 | 1h | 3.6 | 待开始 | AI 回复自动保存 |
| 3.8 | 编写集成测试 | 3h | 3.7 | 待开始 | 完整对话流程测试通过 |
| 3.9 | 端到端测试 | 2h | 3.8 | 待开始 | Telegram bot 实际运行测试 |
| 3.10 | 修复 bug 和优化 | 2h | 3.9 | 待开始 | 所有问题修复 |

**总计**: 20 工时（约 2-3 天）

---

### 阶段 4: Lance 集成（可选，生产环境）

**目标**: 实现高性能向量存储
**工期**: 3-5 天
**优先级**: P1（生产环境）
**依赖**: 阶段 1, 2, 3

#### 任务列表

| ID | 任务 | 工时 | 依赖 | 状态 | 验收标准 |
|----|------|------|------|------|----------|
| 4.1 | 研究 Lance API 文档 | 2h | 3.10 | 待开始 | Lance API 理解完成 |
| 4.2 | 设计 LanceVectorStore 结构 | 2h | 4.1 | 待开始 | 设计文档完成 |
| 4.3 | 实现 LanceVectorStore 基础功能 | 4h | 4.2 | 待开始 | 基础读写功能实现 |
| 4.4 | 实现向量索引创建 | 4h | 4.3 | 待开始 | HNSW/IVF_PQ 索引支持 |
| 4.5 | 实现语义搜索功能 | 3h | 4.4 | 待开始 | 向量搜索功能正常 |
| 4.6 | 实现元数据过滤 | 2h | 4.5 | 待开始 | 按用户、时间范围过滤 |
| 4.7 | 实现批量导入优化 | 3h | 4.6 | 待开始 | 批量操作性能优化 |
| 4.8 | 编写迁移工具 | 3h | 4.7 | 待开始 | 可以从 SQLite 迁移到 Lance |
| 4.9 | 迁移测试数据 | 2h | 4.8 | 待开始 | 测试数据迁移成功 |
| 4.10 | 性能测试和优化 | 4h | 4.9 | 待开始 | 检索性能 < 200ms |
| 4.11 | 更新配置支持 | 1h | 4.10 | 待开始 | 配置文件支持 Lance |
| 4.12 | 编写文档 | 2h | 4.11 | 待开始 | Lance 使用文档完整 |

**总计**: 32 工时（约 4 天）

---

### 阶段 5: 优化和增强

**目标**: 提升性能和用户体验
**工期**: 2-3 天
**优先级**: P2（可选）
**依赖**: 阶段 1, 2, 3

#### 任务列表

| ID | 任务 | 工时 | 依赖 | 状态 | 验收标准 |
|----|------|------|------|------|----------|
| 5.1 | 实现用户偏好自动提取 | 4h | 3.10 | 待开始 | AI 自动识别用户偏好 |
| 5.2 | 实现重要信息自动标记 | 3h | 5.1 | 待开始 | 自动标记邮箱、电话等信息 |
| 5.3 | 实现对话总结功能 | 6h | 5.2 | 待开始 | 长对话自动总结 |
| 5.4 | 实现批量向量化优化 | 2h | 5.3 | 待开始 | 批量 API 调用 |
| 5.5 | 实现向量缓存 | 3h | 5.4 | 待开始 | 减少重复 API 调用 |
| 5.6 | 性能优化和调优 | 4h | 5.5 | 待开始 | 检索响应时间 < 200ms |
| 5.7 | 添加监控和日志 | 2h | 5.6 | 待开始 | 关键指标可观测 |
| 5.8 | 编写增强功能文档 | 2h | 5.7 | 待开始 | 文档完整 |

**总计**: 26 工时（约 3-4 天）

---

## 整体时间表

```
Week 1:
├─ Day 1-2:   阶段 1 - 基础记忆功能
├─ Day 3:     阶段 2 - 上下文构建
└─ Day 4-5:   阶段 3 - 中间件集成

Week 2:
├─ Day 6-9:   阶段 4 - Lance 集成（可选）
└─ Day 10-13: 阶段 5 - 优化和增强（可选）
```

## 里程碑

| 里程碑 | 完成标准 | 预计日期 |
|--------|----------|----------|
| M1: 基础记忆功能完成 | 可以添加、检索记忆，单元测试通过 | Day 2 |
| M2: 上下文构建完成 | 可以构建多种策略的上下文 | Day 3 |
| M3: 中间件集成完成 | 完整对话流程工作正常 | Day 5 |
| M4: MVP 完成 | 基础 RAG 功能可用（使用 SQLite） | Day 5 |
| M5: Lance 集成完成 | Lance 方案可用，性能达标 | Day 9 |
| M6: 增强功能完成 | 优化、总结、偏好提取等 | Day 13 |

## 资源需求

### 人力
- **后端开发工程师**: 1 人全职
- **测试工程师**: 0.5 人（兼职，阶段 3-5）

### 工具和服务
- **OpenAI API Key**: 需要
- **开发环境**: Rust 1.75+, Cargo
- **测试环境**: SQLite、Lance
- **数据库**: 生产环境可选择 Lance 或 SQLite

### 外部依赖
- OpenAI API (Embedding, Chat Completion)
- Lance 2.0 (生产环境可选)

## 风险评估

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| OpenAI API 限流 | 中 | 高 | 实现重试机制、批量处理、缓存 |
| 向量检索性能不达标 | 低 | 中 | 使用 Lance、优化索引、缓存 |
| 数据迁移问题 | 低 | 中 | 编写完善的迁移工具、测试 |
| 内存占用过高 | 中 | 低 | 使用 Lance 方案、定期清理 |

## 验收标准

### MVP 阶段（阶段 1-3）
- ✅ 可以添加和检索记忆
- ✅ 可以进行语义搜索
- ✅ 可以构建上下文
- ✅ 完整对话流程工作正常
- ✅ 单元测试覆盖率 > 80%
- ✅ 集成测试通过

### 完整版（阶段 1-5）
- ✅ MVP 所有功能
- ✅ Lance 方案可用
- ✅ 检索响应时间 < 200ms
- ✅ 自动提取用户偏好
- ✅ 自动标记重要信息
- ✅ 对话总结功能
- ✅ 监控和日志完善

## 后续工作

### 短期（2周内）
- 部署到测试环境
- 收集用户反馈
- 修复 bug

### 中期（1-2月）
- 根据反馈优化功能
- 实现未来扩展中的高优先级功能
  - 记忆导出
  - 对话分段

### 长期（3月+）
- 实现低优先级扩展功能
  - 时间衰减
  - 多模态记忆
  - 情感分析
  - 智能遗忘
  - 跨用户检索

## 沟通计划

### 日报
- 每日下班前提交
- 包含：完成任务、遇到的问题、明日计划

### 周报
- 每周五提交
- 包含：本周进度、下周计划、风险预警

### 里程碑评审
- 每个里程碑完成后
- 评审成果、讨论后续计划

## 附录

### 任务状态说明
- **待开始**: 任务尚未开始
- **进行中**: 任务正在执行
- **已完成**: 任务已完成并通过验收
- **阻塞**: 任务被依赖项阻塞
- **已取消**: 任务被取消

### 优先级说明
- **P0**: 必须完成，阻塞 MVP 上线
- **P1**: 生产环境重要，可延后
- **P2**: 增强功能，可选

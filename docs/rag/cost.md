# 成本估算

## OpenAI Embedding API

### 定价

- **text-embedding-3-small**: $0.00002 / 1K tokens
- **text-embedding-3-large**: $0.00013 / 1K tokens
- **text-embedding-ada-002**: $0.0001 / 1K tokens

## 智谱AI Embedding API

### 定价

- **embedding-2**: 具体价格需查询 https://open.bigmodel.cn/
- **优势**: 国产服务，中文支持优秀，国内访问更快

### 模型对比

| 服务 | 模型 | 向量维度 | 定价 | 优势 |
|-------|-------|---------|------|------|
| OpenAI | text-embedding-3-small | 1536 | $0.02/1M tokens | 成熟稳定 |
| OpenAI | text-embedding-3-large | 3072 | $0.13/1M tokens | 性能更好 |
| 智谱AI | embedding-2 | 1024 | 查询官网 | 中文优化，国内快 |

### 计算示例

假设每天1000条消息 × 平均50 tokens = 50K tokens

**使用 text-embedding-3-small**:
- 日成本：50,000 tokens × $0.00002 / 1,000 tokens = $0.001
- 月成本：$0.001 × 30 = $0.03
- 年成本：$0.001 × 365 = $0.37

**使用 text-embedding-3-large**:
- 日成本：50,000 tokens × $0.00013 / 1,000 tokens = $0.0065
- 月成本：$0.0065 × 30 = $0.20
- 年成本：$0.0065 × 365 = $2.37

**使用 智谱AI embedding-2**:
- 日成本：需查询官网定价（可能更低）
- 优势：中文文本通常token数更少，可能降低成本

## 存储

### 内存+SQLite方案

假设10000条记忆：

**使用 OpenAI（1536维）**:
- 平均每条消息：50 tokens
- 向量维度：1536维
- 每个float32：4字节

**计算**：
- 向量存储：10,000 × 1536 × 4 = 61,440,000 字节 ≈ 58.6 MB

**使用 智谱AI（1024维）**:
- 平均每条消息：50 tokens
- 向量维度：1024维
- 每个float32：4字节

**计算**：
- 向量存储：10,000 × 1024 × 4 = 40,960,000 字节 ≈ 39.1 MB

假设10000条记忆：
- 平均每条消息：50 tokens
- 向量维度：1536维
- 每个float32：4字节

**计算**：
- 向量存储：10,000 × 1536 × 4 = 61,440,000 字节 ≈ 58.6 MB
- 文本内容：10,000 × 50 字符 × 1 字节 ≈ 500 KB
- 元数据：10,000 × 200 字节 ≈ 2 MB
- 索引开销：约10 MB

**总计**：
- 内存占用：~70 MB（常驻内存）
- SQLite存储：~5 MB（磁盘）
- **总内存需求**：~75 MB

### Lance方案

假设10000条记忆：
- 向量数据：同上 ≈ 58.6 MB
- 文本和元数据：同上 ≈ 2.5 MB
- 索引（HNSW）：约100-200 MB
- 压缩存储（Lance支持）：约30%压缩率

**总计**：
- 磁盘占用：~100-150 MB
- 内存缓存：~50-100 MB（可配置）

### 大规模场景（10万条）

**内存+SQLite**：
- 向量存储：~600 MB
- 内存占用：~750 MB

**Lance**：
- 磁盘占用：~1-1.5 GB
- 内存占用：~200-500 MB

## 运行成本

### 每条消息处理成本

1. 用户消息向量化：1次API调用
2. AI回复向量化：1次API调用

**总计**：2次API调用 / 消息

### 成本对比

| 场景 | 日消息数 | 日API调用 | OpenAI small | OpenAI large | 智谱AI |
|------|---------|---------|-------------|-------------|--------|
| 小规模 | 100 | 200 | $0.0002 | $0.0013 | 需查询官网 |
| 中规模 | 1,000 | 2,000 | $0.002 | $0.013 | 需查询官网 |
| 大规模 | 10,000 | 20,000 | $0.02 | $0.13 | 需查询官网 |
| 超大规模 | 100,000 | 200,000 | $0.20 | $1.30 | 需查询官网 |

## 方案对比

| 方案 | 初始开发 | 部署复杂度 | 内存占用 | 磁盘占用 | 适用场景 |
|------|---------|-----------|---------|---------|---------|
| 内存+SQLite（OpenAI） | 1-2天 | 简单 | 75MB/万条 | 5MB | 原型、小规模 |
| 内存+SQLite（智谱AI） | 1-2天 | 简单 | 50MB/万条 | 5MB | 原型、小规模（中文） |
| Lance（OpenAI） | 3-5天 | 简单 | 50-100MB | 100-150MB/万条 | 生产、大规模 |
| Lance（智谱AI） | 3-5天 | 简单 | 30-60MB | 70-100MB/万条 | 生产、大规模（中文） |

## 成本优化建议

### 1. 嵌入模型选择

- 小规模、预算有限：使用 text-embedding-3-small
- 追求质量：使用 text-embedding-3-large

### 2. 批量处理

- 批量向量化降低API调用开销
- 建议批量大小：10-20

### 3. 缓存策略

- 缓存重复文本的向量
- 减少API调用次数

### 4. 记忆管理

- 定期清理旧记忆
- 压缩长对话总结

### 5. 存储优化

- 使用Lance的压缩功能
- 定期重建索引

## 总结

**小规模应用（<1万条记忆）**：
- 年API成本：~$0.37（small模型）
- 存储需求：~75MB内存
- 总成本：极低

**中规模应用（<10万条记忆）**：
- 年API成本：~$3.7（small模型）
- 存储需求：~750MB内存或1GB磁盘（Lance）
- 总成本：低

**大规模应用（>10万条记忆）**：
- 推荐使用Lance
- 成本随规模线性增长
- 可通过批量处理、缓存优化
